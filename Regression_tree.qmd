---
title: "Regression_tree"
format: html
---

```{r}
library(tidyverse)
library(tidymodels)
library(vroom)
library(ggplot2)
library(ranger)
```

```{r}
#loading data

#training
trainData <- vroom::vroom("./train.csv", show_col_types = FALSE) %>%
  select(-casual, -registered) %>%
  mutate(count = log1p(count))

#test
testData <- vroom::vroom("./test.csv", show_col_types = FALSE)
```

```{r}
#building the recipe
bike_recipe <- recipe(count ~ ., data = trainData) %>%
  step_mutate(weather = ifelse(weather == 4, 3, weather)) %>%
  step_mutate(weather = factor(weather, levels = c(1, 2, 3))) %>%
  step_time(datetime, features = c("hour"), keep_original_cols = FALSE) %>%
  step_mutate(season = factor(season,
                              levels = c(1, 2, 3, 4),
                              labels = c("spring", "summer", "fall", "winter"))) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_normalize(all_numeric_predictors())

bakedBike <- recipe(trainData)
```

```{r}
#random forest
rf_model <- rand_forest(mtry = tune(),
                        min_n = tune(),
                        trees = 500) %>%
  set_engine("ranger") %>%
  set_mode("regression")

#workflow for the forest model
rf_wf <- workflow() %>%
  add_recipe(bike_recipe) %>% 
  add_model(rf_model)

#kfolds for cv
folds <- vfold_cv(trainData, v = 10, repeats = 1) 
```

```{r}
#grid of tuning values for the tree
rf_grid <- grid_regular(
  mtry(range = c(1, 8)),
  min_n(range = c(2, 40)),
  levels = 4
)

#cross-validation tuning for the tree model
rf_CV_results <- rf_wf %>%
  tune_grid(
    resamples = folds,
    grid = rf_grid,
    metrics = metric_set(rmse, mae)
  )
```

```{r}
# tuning parameters based on RMSE
bestTune <- rf_CV_results %>%
  select_best(metric = "rmse")

print(bestTune)
```

```{r}
# final workflow with the best tree tuning parameters
final_rf_wf <- rf_wf %>%
  finalize_workflow(bestTune)

# Fit the final workflow on the training data
final_rf_fit <- fit(final_rf_wf, data = trainData)

# predict on the test data
rf_predictions <- predict(final_rf_fit, new_data = testData)

# submission file
submission_rf <- rf_predictions %>%
  mutate(.pred = pmax(0, round(expm1(.pred)))) %>%
  rename(count = .pred) %>%
  bind_cols(testData %>% select(datetime)) %>%
  select(datetime, count) %>%
  mutate(datetime = format(as.POSIXct(datetime, tz = "UTC"), "%Y-%m-%d %H:%M:%S"))

# export submission file
vroom::vroom_write(submission_rf, "submission_rf.csv", delim = ',')
```

\
